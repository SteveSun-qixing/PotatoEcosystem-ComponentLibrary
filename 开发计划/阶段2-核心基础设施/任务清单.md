# 阶段2: 核心基础设施 - 任务清单

**阶段目标**: 实现组件库的核心基础设施，为组件开发提供必要的支撑  
**预计任务数**: 14  
**依赖**: 阶段1完成  
**状态**: 待开始

---

## 任务列表

### 任务2.1: 实现 classNames 工具函数

**描述**: 实现动态类名组合工具函数

**功能要求**:
- 支持字符串、数组、对象等多种输入
- 支持条件类名
- 返回合并后的类名字符串

**代码示例**:
```typescript
// src/utils/classNames.ts
export type ClassValue = 
  | string 
  | number 
  | boolean 
  | undefined 
  | null 
  | ClassValue[] 
  | { [key: string]: boolean | undefined | null };

export function classNames(...args: ClassValue[]): string {
  // 实现
}

// 使用示例
classNames('chips-button', { 'chips-button-primary': true })
// 输出: 'chips-button chips-button-primary'
```

**测试用例**:
- 字符串输入
- 对象条件输入
- 数组输入
- 混合输入
- 空值和假值处理

**验收标准**:
- [ ] 函数实现完成
- [ ] 类型定义完整
- [ ] 单元测试覆盖率 100%
- [ ] 导出配置正确

---

### 任务2.2: 实现 mergeRefs 工具函数

**描述**: 实现合并多个 ref 的工具函数

**功能要求**:
- 支持合并多个 Vue ref
- 支持回调式 ref
- 支持 null/undefined 处理

**代码示例**:
```typescript
// src/utils/mergeRefs.ts
import type { Ref } from 'vue';

export type RefCallback<T> = (instance: T | null) => void;
export type RefValue<T> = Ref<T | null> | RefCallback<T> | null | undefined;

export function mergeRefs<T>(...refs: RefValue<T>[]): RefCallback<T> {
  // 实现
}
```

**验收标准**:
- [ ] 函数实现完成
- [ ] 类型定义完整
- [ ] 单元测试通过

---

### 任务2.3: 实现通用工具函数

**描述**: 实现其他通用工具函数

**函数列表**:
1. `composeEventHandlers` - 组合多个事件处理器
2. `debounce` - 防抖函数
3. `throttle` - 节流函数
4. `generateId` - 生成唯一ID
5. `isNullish` - 判断空值
6. `omit` - 对象属性过滤
7. `pick` - 对象属性选取

**代码示例**:
```typescript
// composeEventHandlers
export function composeEventHandlers<E>(
  externalHandler?: (event: E) => void,
  internalHandler?: (event: E) => void,
  options?: { checkDefaultPrevented?: boolean }
): (event: E) => void {
  // 实现
}
```

**验收标准**:
- [ ] 所有工具函数实现完成
- [ ] 类型定义完整
- [ ] 单元测试覆盖

---

### 任务2.4: 实现类型定义系统

**描述**: 建立组件库的核心类型定义

**类型文件**:
1. `types/component.ts` - 组件基础类型
2. `types/theme.ts` - 主题相关类型
3. `types/kernel.ts` - 内核通信类型
4. `types/event.ts` - 事件类型
5. `types/common.ts` - 通用类型

**核心类型**:
```typescript
// types/component.ts
export interface ChipsComponentBase {
  componentName: string;
  styleInterfaces: string[];
}

export type Size = 'small' | 'medium' | 'large';
export type Status = 'success' | 'warning' | 'error' | 'info';

// types/theme.ts
export interface ThemeVariables {
  colors: ColorTokens;
  typography: TypographyTokens;
  spacing: SpacingTokens;
  borderRadius: BorderRadiusTokens;
  shadows: ShadowTokens;
  transitions: TransitionTokens;
}

export interface Theme {
  id: string;
  name: string;
  variables: ThemeVariables;
  components: Record<string, ComponentTheme>;
}
```

**验收标准**:
- [ ] 所有类型定义完成
- [ ] 类型导出正确
- [ ] 无 TypeScript 错误

---

### 任务2.5: 实现 ThemeContext

**描述**: 实现主题上下文管理

**功能要求**:
- 创建 Vue 的 provide/inject 上下文
- 支持主题状态管理
- 支持主题变更通知
- 支持主题嵌套

**代码示例**:
```typescript
// src/theme/ThemeContext.ts
import { InjectionKey, Ref } from 'vue';
import type { Theme } from '@/types';

export interface ThemeContextValue {
  theme: Ref<Theme | null>;
  setTheme: (theme: Theme) => void;
  getEffectiveTheme: () => Theme;
}

export const ThemeContextKey: InjectionKey<ThemeContextValue> = Symbol('ThemeContext');

export function createThemeContext(): ThemeContextValue {
  // 实现
}
```

**验收标准**:
- [ ] ThemeContext 实现完成
- [ ] provide/inject 机制正常工作
- [ ] 主题切换功能正常

---

### 任务2.6: 实现 ThemeProvider 组件

**描述**: 实现主题提供者组件

**功能要求**:
- 接收主题配置
- 注入主题到子组件
- 支持动态切换主题
- 支持CSS变量注入

**Props接口**:
```typescript
interface ThemeProviderProps {
  theme?: Theme | string;  // 主题对象或主题ID
  children?: unknown;
}
```

**样式接口点**:
- `.chips-theme-provider`

**验收标准**:
- [ ] 组件实现完成
- [ ] 主题注入正常
- [ ] CSS变量注入正常
- [ ] 单元测试通过

---

### 任务2.7: 实现 useTheme 组合式函数

**描述**: 实现获取主题的组合式函数

**功能要求**:
- 获取当前主题
- 获取主题变量
- 监听主题变化

**代码示例**:
```typescript
// src/composables/useTheme.ts
export function useTheme() {
  const context = inject(ThemeContextKey);
  
  return {
    theme: computed(() => context?.theme.value),
    getVariable: (path: string) => { /* 获取主题变量 */ },
    isDark: computed(() => { /* 判断是否深色主题 */ })
  };
}
```

**验收标准**:
- [ ] 组合式函数实现完成
- [ ] 可正确获取主题
- [ ] 响应式更新正常

---

### 任务2.8: 实现内核通信 SDKIntegration

**描述**: 实现与薯片内核SDK的集成层

**功能要求**:
- 封装 Core.request 调用
- 标准化请求响应格式
- 错误处理封装
- 连接状态管理

**代码示例**:
```typescript
// src/kernel/SDKIntegration.ts
export interface KernelRequest {
  target: string;
  action: string;
  params?: Record<string, unknown>;
}

export interface KernelResponse<T = unknown> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}

export class SDKIntegration {
  private static instance: SDKIntegration;
  
  static getInstance(): SDKIntegration {
    if (!this.instance) {
      this.instance = new SDKIntegration();
    }
    return this.instance;
  }
  
  async request<T>(req: KernelRequest): Promise<KernelResponse<T>> {
    // 调用 Core.request
  }
}
```

**验收标准**:
- [ ] SDKIntegration 实现完成
- [ ] 请求响应格式标准化
- [ ] 错误处理完善
- [ ] 单例模式正确

---

### 任务2.9: 实现 useKernel 组合式函数

**描述**: 实现内核通信的组合式函数

**功能要求**:
- 封装内核请求调用
- 提供简便的API
- 支持加载状态管理
- 支持错误处理

**代码示例**:
```typescript
// src/composables/useKernel.ts
export function useKernel() {
  const sdk = SDKIntegration.getInstance();
  
  const request = async <T>(target: string, action: string, params?: Record<string, unknown>) => {
    return sdk.request<T>({ target, action, params });
  };
  
  return {
    request,
    // 常用快捷方法
    callUIControls: (action: string, params?: unknown) => request('UIControls', action, params),
    callWindowManager: (action: string, params?: unknown) => request('WindowManager', action, params),
    // ...
  };
}
```

**验收标准**:
- [ ] 组合式函数实现完成
- [ ] API 简洁易用
- [ ] 类型定义完整

---

### 任务2.10: 实现多语言系统集成

**描述**: 集成薯片生态的多语言系统

**功能要求**:
- 实现 t() 翻译函数
- 支持变量插值
- 支持复数形式
- 支持日期和数字格式化

**代码示例**:
```typescript
// src/i18n/useTranslation.ts
export function useTranslation() {
  const kernel = useKernel();
  
  const t = (key: string, vars?: Record<string, unknown>): string => {
    // 调用系统多语言服务
    // 开发阶段返回 key 对应的文本
    // 生产环境使用编码
  };
  
  const formatDate = (date: Date, format?: string): string => {
    // 日期格式化
  };
  
  const formatNumber = (num: number, options?: Intl.NumberFormatOptions): string => {
    // 数字格式化
  };
  
  return { t, formatDate, formatNumber };
}
```

**开发阶段词汇表**:
```yaml
# src/i18n/dev_i18n.yaml
common:
  ok: "确定"
  cancel: "取消"
  save: "保存"
  delete: "删除"
  loading: "加载中..."
  
ui:
  empty_data: "暂无数据"
  select_placeholder: "请选择"
  input_placeholder: "请输入"
```

**验收标准**:
- [ ] 多语言系统集成完成
- [ ] t() 函数可正常使用
- [ ] 开发阶段词汇表完成
- [ ] 格式化功能正常

---

### 任务2.11: 实现 ChipsProvider 组件

**描述**: 实现生态上下文提供者组件

**功能要求**:
- 注入内核连接
- 注入全局配置
- 注入主题上下文
- 注入多语言上下文

**Props接口**:
```typescript
interface ChipsProviderProps {
  theme?: Theme | string;
  locale?: string;
  config?: GlobalConfig;
}
```

**代码示例**:
```vue
<!-- src/components/providers/ChipsProvider.vue -->
<script setup lang="ts">
import { provide } from 'vue';
import { ThemeContextKey, createThemeContext } from '@/theme';
import { KernelContextKey, createKernelContext } from '@/kernel';

const props = defineProps<ChipsProviderProps>();

// 创建上下文
const themeContext = createThemeContext(props.theme);
const kernelContext = createKernelContext();

// 提供上下文
provide(ThemeContextKey, themeContext);
provide(KernelContextKey, kernelContext);
</script>

<template>
  <div class="chips-provider">
    <slot />
  </div>
</template>
```

**验收标准**:
- [ ] ChipsProvider 实现完成
- [ ] 所有上下文正确注入
- [ ] 子组件可正常访问上下文

---

### 任务2.12: 实现 useControllableState 组合式函数

**描述**: 实现受控/非受控状态管理的通用组合式函数

**功能要求**:
- 支持受控模式（外部控制值）
- 支持非受控模式（内部管理值）
- 自动判断模式
- 提供统一的 API

**代码示例**:
```typescript
// src/composables/useControllableState.ts
interface UseControllableStateOptions<T> {
  value?: T;
  defaultValue?: T;
  onChange?: (value: T) => void;
}

export function useControllableState<T>(options: UseControllableStateOptions<T>) {
  const { value: controlledValue, defaultValue, onChange } = options;
  
  const isControlled = controlledValue !== undefined;
  const internalValue = ref(defaultValue);
  
  const value = computed(() => 
    isControlled ? controlledValue : internalValue.value
  );
  
  const setValue = (newValue: T) => {
    if (!isControlled) {
      internalValue.value = newValue;
    }
    onChange?.(newValue);
  };
  
  return [value, setValue] as const;
}
```

**验收标准**:
- [ ] 组合式函数实现完成
- [ ] 受控/非受控模式切换正常
- [ ] 类型定义完整
- [ ] 单元测试通过

---

### 任务2.13: 实现常量定义

**描述**: 定义组件库使用的常量

**常量类型**:
1. 组件名称常量
2. 样式接口点前缀
3. 尺寸枚举
4. 状态枚举
5. 键盘按键常量

**代码示例**:
```typescript
// src/constants/index.ts
export const COMPONENT_PREFIX = 'chips';

export const SIZES = {
  SMALL: 'small',
  MEDIUM: 'medium',
  LARGE: 'large',
} as const;

export const STATUS = {
  SUCCESS: 'success',
  WARNING: 'warning',
  ERROR: 'error',
  INFO: 'info',
} as const;

export const KEYS = {
  ENTER: 'Enter',
  ESCAPE: 'Escape',
  SPACE: ' ',
  TAB: 'Tab',
  ARROW_UP: 'ArrowUp',
  ARROW_DOWN: 'ArrowDown',
  ARROW_LEFT: 'ArrowLeft',
  ARROW_RIGHT: 'ArrowRight',
} as const;
```

**验收标准**:
- [ ] 常量定义完成
- [ ] 类型导出正确
- [ ] 可正常使用

---

### 任务2.14: 阶段验证和提交

**描述**: 完成核心基础设施的验证和提交

**详细步骤**:
1. 编写集成测试验证各模块协作
2. 运行所有单元测试
3. 验证 lint 和类型检查
4. 提交代码
5. 编写阶段完成总结

**验收标准**:
- [ ] 所有模块可正常工作
- [ ] 单元测试全部通过
- [ ] 集成测试通过
- [ ] 代码提交完成
- [ ] 阶段总结编写完成

---

## 阶段验收标准

完成本阶段需满足以下条件：

- [ ] 所有工具函数实现完成且测试通过
- [ ] 主题系统（ThemeContext、ThemeProvider、useTheme）正常工作
- [ ] 内核通信层可正常调用基础层
- [ ] 多语言系统集成完成
- [ ] ChipsProvider 可正常注入所有上下文
- [ ] 所有组合式函数可正常使用
- [ ] 类型定义完整无错误
- [ ] 单元测试覆盖率 ≥80%

---

## 注意事项

1. **不包含样式代码**: 所有组件和工具不包含任何 CSS
2. **类型优先**: 先定义类型，再实现功能
3. **测试驱动**: 编写测试用例，再实现功能
4. **模块解耦**: 各模块通过接口通信，避免直接依赖

---

**更新时间**: 2026-02-01
