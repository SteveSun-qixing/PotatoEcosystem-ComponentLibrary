# 阶段7: P2组件和完善 - 任务清单

**阶段目标**: 实现扩展组件并完善整体功能  
**预计任务数**: 12  
**依赖**: 阶段6完成  
**状态**: 待开始

---

## 任务列表

### 任务7.1: 实现 Tree 树形控件组件

**描述**: 实现树形数据展示和选择组件

**Props接口**:
```typescript
interface TreeProps {
  treeData: TreeNode[];
  expandedKeys?: string[];
  defaultExpandedKeys?: string[];
  selectedKeys?: string[];
  defaultSelectedKeys?: string[];
  checkedKeys?: string[] | { checked: string[]; halfChecked: string[] };
  defaultCheckedKeys?: string[];
  checkable?: boolean;
  checkStrictly?: boolean;
  selectable?: boolean;
  multiple?: boolean;
  draggable?: boolean;
  blockNode?: boolean;
  showLine?: boolean | { showLeafIcon: boolean };
  showIcon?: boolean;
  switcherIcon?: VNode | ((props: { expanded: boolean }) => VNode);
  icon?: VNode | ((props: TreeNode) => VNode);
  virtual?: boolean;
  height?: number;
  fieldNames?: { title?: string; key?: string; children?: string };
  loadData?: (node: TreeNode) => Promise<void>;
  filterTreeNode?: (node: TreeNode) => boolean;
}

interface TreeNode {
  key: string;
  title: string | VNode;
  children?: TreeNode[];
  disabled?: boolean;
  disableCheckbox?: boolean;
  selectable?: boolean;
  checkable?: boolean;
  isLeaf?: boolean;
  icon?: VNode;
}

interface TreeEmits {
  'update:expandedKeys': [keys: string[]];
  'update:selectedKeys': [keys: string[]];
  'update:checkedKeys': [keys: string[] | { checked: string[]; halfChecked: string[] }];
  expand: [keys: string[], info: { node: TreeNode; expanded: boolean }];
  select: [keys: string[], info: { node: TreeNode; selected: boolean }];
  check: [keys: string[], info: { node: TreeNode; checked: boolean; halfCheckedKeys: string[] }];
  load: [keys: string[], info: { node: TreeNode }];
  dragStart: [info: { node: TreeNode; event: DragEvent }];
  dragEnter: [info: { node: TreeNode; expandedKeys: string[]; event: DragEvent }];
  dragOver: [info: { node: TreeNode; event: DragEvent }];
  dragLeave: [info: { node: TreeNode; event: DragEvent }];
  dragEnd: [info: { node: TreeNode; event: DragEvent }];
  drop: [info: { node: TreeNode; dragNode: TreeNode; dropPosition: number; dropToGap: boolean }];
}
```

**功能要求**:
- 树形数据展示
- 节点展开/折叠
- 节点选择（单选/多选）
- 节点勾选（复选框）
- 异步加载
- 拖拽排序
- 虚拟滚动（大数据量）
- 搜索过滤

**与基础层集成**:
- 调用 `DragDropSystem` 实现节点拖拽

**样式接口点**:
```
.chips-tree
.chips-tree--show-line
.chips-tree--block-node
.chips-tree--dragging
.chips-tree__node
.chips-tree__node--expanded
.chips-tree__node--selected
.chips-tree__node--checked
.chips-tree__node--disabled
.chips-tree__node--loading
.chips-tree__node--dragging
.chips-tree__node--drop-target
.chips-tree__switcher
.chips-tree__switcher--open
.chips-tree__checkbox
.chips-tree__icon
.chips-tree__title
.chips-tree__indent
.chips-tree__drop-indicator
```

**测试用例**:
- 树形数据渲染
- 展开/折叠功能
- 选择功能
- 勾选功能
- 异步加载
- 拖拽排序
- 虚拟滚动性能

**验收标准**:
- [ ] 组件实现完成
- [ ] 所有功能正常
- [ ] 拖拽集成基础层
- [ ] 虚拟滚动支持
- [ ] 单元测试覆盖率 ≥80%

---

### 任务7.2: 实现 FormList 动态表单列表组件

**描述**: 实现动态增删的表单列表

**Props接口**:
```typescript
interface FormListProps {
  name: string | string[];
  initialValue?: unknown[];
  rules?: FormRule[];
}

interface FormListField {
  name: number;
  key: number;
  isListField: true;
}

interface FormListOperation {
  add: (defaultValue?: unknown, insertIndex?: number) => void;
  remove: (index: number | number[]) => void;
  move: (from: number, to: number) => void;
}

// Slot props
interface FormListSlotProps {
  fields: FormListField[];
  operations: FormListOperation;
  meta: { errors: string[] };
}
```

**功能要求**:
- 动态添加表单项
- 动态删除表单项
- 表单项排序（移动）
- 与 Form 联动验证
- 初始值支持

**样式接口点**:
```
.chips-form-list
.chips-form-list__item
.chips-form-list__item-actions
.chips-form-list__add-btn
.chips-form-list__remove-btn
.chips-form-list__move-btn
```

**验收标准**:
- [ ] 组件实现完成
- [ ] 与 Form 联动正常
- [ ] 增删移动功能正常
- [ ] 单元测试覆盖率 ≥80%

---

### 任务7.3: 实现 CardPlaceholder 卡片占位符组件

**描述**: 卡片内容为空时的占位展示

**Props接口**:
```typescript
interface CardPlaceholderProps {
  icon?: VNode;
  text?: string;
  description?: string;
  actionText?: string;
}

interface CardPlaceholderEmits {
  action: [];
}
```

**样式接口点**:
```
.chips-card-placeholder
.chips-card-placeholder__icon
.chips-card-placeholder__text
.chips-card-placeholder__description
.chips-card-placeholder__action
```

**验收标准**:
- [ ] 组件实现完成
- [ ] 单元测试覆盖率 ≥80%

---

### 任务7.4: 实现 ErrorBoundary 错误边界组件

**描述**: Vue 错误边界组件，捕获子组件错误

**Props接口**:
```typescript
interface ErrorBoundaryProps {
  fallback?: VNode | ((props: { error: Error; reset: () => void }) => VNode);
  onError?: (error: Error, info: { componentStack: string }) => void;
}

interface ErrorBoundarySlots {
  default?: () => VNode;
  fallback?: (props: { error: Error; reset: () => void }) => VNode;
}
```

**功能要求**:
- 捕获渲染错误
- 显示降级 UI
- 支持重试
- 错误日志记录

**样式接口点**:
```
.chips-error-boundary
.chips-error-boundary__fallback
.chips-error-boundary__error-icon
.chips-error-boundary__error-message
.chips-error-boundary__retry-btn
```

**验收标准**:
- [ ] 组件实现完成
- [ ] 错误捕获正常
- [ ] 重试功能正常
- [ ] 单元测试覆盖率 ≥80%

---

### 任务7.5: 无障碍（ARIA）完善

**描述**: 为所有组件添加完整的无障碍支持

**工作内容**:
1. **语义化 HTML**
   - 使用正确的 HTML 元素
   - 添加 role 属性
   
2. **ARIA 属性**
   - aria-label / aria-labelledby
   - aria-describedby
   - aria-expanded / aria-collapsed
   - aria-selected / aria-checked
   - aria-disabled
   - aria-hidden
   - aria-live（动态内容）

3. **焦点管理**
   - tabindex 设置
   - 焦点陷阱（Modal、Drawer）
   - 焦点顺序
   - 焦点可见性

**需要检查的组件**:
- [ ] Button - role="button", aria-disabled, aria-pressed
- [ ] Input - aria-invalid, aria-describedby
- [ ] Select - role="listbox", aria-expanded
- [ ] Checkbox - role="checkbox", aria-checked
- [ ] Radio - role="radio", aria-checked
- [ ] Switch - role="switch", aria-checked
- [ ] Modal - role="dialog", aria-modal, aria-labelledby
- [ ] Menu - role="menu", role="menuitem"
- [ ] Tabs - role="tablist", role="tab", role="tabpanel"
- [ ] Tree - role="tree", role="treeitem"
- [ ] Table - role="grid" 或使用原生 table

**验收标准**:
- [ ] 所有组件添加正确的 ARIA 属性
- [ ] 屏幕阅读器测试通过
- [ ] WCAG 2.1 AA 标准检查通过

---

### 任务7.6: 键盘导航增强

**描述**: 确保所有可交互组件支持完整的键盘操作

**键盘操作规范**:

| 组件 | 按键 | 操作 |
|------|------|------|
| Button | Enter/Space | 触发点击 |
| Input | Escape | 清除（如果 clearable） |
| Select | Enter | 打开/选择 |
| Select | Escape | 关闭 |
| Select | ↑↓ | 导航选项 |
| Checkbox | Space | 切换选中 |
| Switch | Space | 切换开关 |
| Modal | Escape | 关闭 |
| Menu | ↑↓ | 导航菜单项 |
| Menu | Enter | 选择/展开 |
| Menu | ←→ | 展开/收起子菜单 |
| Tabs | ←→ | 切换标签 |
| Tree | ↑↓ | 导航节点 |
| Tree | ←→ | 展开/收起 |
| Tree | Space | 选中/勾选 |

**实现要求**:
- 使用 useKeyboard 组合式函数
- 统一的按键处理逻辑
- 支持自定义快捷键

**验收标准**:
- [ ] 所有组件支持键盘操作
- [ ] 键盘操作符合预期
- [ ] 无障碍键盘测试通过

---

### 任务7.7: 响应式设计优化

**描述**: 确保所有组件在不同屏幕尺寸下正常显示

**工作内容**:
1. **useBreakpoint 组合式函数**
   ```typescript
   export function useBreakpoint() {
     const breakpoint = ref<Breakpoint>('lg');
     
     // 监听窗口大小变化
     // 返回当前断点
     
     return {
       breakpoint,
       isMobile: computed(() => ['xs', 'sm'].includes(breakpoint.value)),
       isTablet: computed(() => breakpoint.value === 'md'),
       isDesktop: computed(() => ['lg', 'xl', 'xxl'].includes(breakpoint.value)),
     };
   }
   ```

2. **组件响应式适配**
   - Modal 移动端全屏
   - Drawer 移动端宽度调整
   - Table 移动端横向滚动
   - Menu 移动端抽屉模式
   - DatePicker 移动端适配

3. **样式接口点补充**
   - 添加响应式相关类名

**验收标准**:
- [ ] useBreakpoint 实现完成
- [ ] 关键组件响应式适配
- [ ] 移动端测试通过

---

### 任务7.8: 虚拟滚动优化

**描述**: 为大数据量组件实现虚拟滚动

**需要支持的组件**:
- Select（大量选项）
- Table（大量行）
- Tree（大量节点）
- List（大量项）

**实现方案**:
```typescript
// useVirtualScroll 组合式函数
interface UseVirtualScrollOptions {
  itemHeight: number | ((index: number) => number);
  overscan?: number;
  containerRef: Ref<HTMLElement | null>;
}

interface VirtualScrollResult {
  list: ComputedRef<VirtualItem[]>;
  containerProps: ComputedRef<{ style: CSSProperties }>;
  wrapperProps: ComputedRef<{ style: CSSProperties }>;
  scrollTo: (index: number) => void;
}

export function useVirtualScroll<T>(
  items: Ref<T[]>,
  options: UseVirtualScrollOptions
): VirtualScrollResult {
  // 实现虚拟滚动逻辑
}
```

**性能目标**:
- 10000 条数据渲染流畅
- 滚动帧率 ≥60fps
- 内存占用稳定

**验收标准**:
- [ ] useVirtualScroll 实现完成
- [ ] Select 虚拟滚动支持
- [ ] Table 虚拟滚动支持
- [ ] Tree 虚拟滚动支持
- [ ] 性能测试达标

---

### 任务7.9: 性能优化

**描述**: 全面优化组件库性能

**优化项目**:

1. **渲染优化**
   - 使用 shallowRef 优化大对象
   - 使用 computed 缓存计算结果
   - 避免不必要的响应式转换
   - 组件懒加载

2. **事件优化**
   - 事件防抖/节流
   - 事件委托
   - 及时清理事件监听

3. **内存优化**
   - 及时清理定时器
   - 组件卸载时清理资源
   - 避免内存泄漏

4. **打包优化**
   - Tree shaking 支持
   - 按需加载配置
   - 代码分割

**性能指标**:
- 组件渲染时间 < 100ms
- 主题切换时间 < 200ms
- 核心包体积 < 100KB (gzipped)
- 首屏加载时间 < 1s

**验收标准**:
- [ ] 性能基准测试完成
- [ ] 所有指标达标
- [ ] 无内存泄漏
- [ ] Tree shaking 有效

---

### 任务7.10: 组件文档完善

**描述**: 为所有组件编写完整的文档

**文档内容**:
每个组件文档包含：
1. 组件说明
2. 何时使用
3. 代码示例（基础、高级）
4. Props API
5. Events API
6. Slots API
7. 样式接口点
8. 无障碍说明
9. 最佳实践
10. 常见问题

**验收标准**:
- [ ] 所有组件文档完成
- [ ] 示例代码可运行
- [ ] API 文档准确

---

### 任务7.11: 单元测试补充

**描述**: 补充单元测试，确保覆盖率达标

**测试目标**:
- 语句覆盖率 ≥80%
- 分支覆盖率 ≥75%
- 函数覆盖率 ≥80%

**需要补充的测试**:
- 边界条件测试
- 错误处理测试
- 异步操作测试
- 事件测试
- 快照测试

**验收标准**:
- [ ] 覆盖率达标
- [ ] 所有测试通过
- [ ] 测试报告生成

---

### 任务7.12: 阶段验证和提交

**描述**: 完成 P2 组件和完善工作的验证和提交

**验收标准**:
- [ ] 所有测试通过
- [ ] 无障碍检查通过
- [ ] 性能指标达标
- [ ] 文档完整
- [ ] 代码提交完成
- [ ] 阶段总结编写完成

---

## 阶段验收标准

- [ ] Tree 组件完成
- [ ] FormList 组件完成
- [ ] CardPlaceholder 组件完成
- [ ] ErrorBoundary 组件完成
- [ ] 无障碍支持完善
- [ ] 键盘导航完善
- [ ] 响应式设计完善
- [ ] 虚拟滚动实现
- [ ] 性能优化完成
- [ ] 文档完善
- [ ] 测试覆盖率 ≥80%

---

**更新时间**: 2026-02-01
