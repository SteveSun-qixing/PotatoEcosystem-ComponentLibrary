# æµ‹è¯•æ‰‹å†Œ

## æµ‹è¯•æ¦‚è¿°

æœ¬æµ‹è¯•æ‰‹å†Œæä¾›Chipså‰ç«¯ç»„ä»¶åº“çš„å®Œæ•´æµ‹è¯•ç­–ç•¥ã€æµ‹è¯•æ¡†æ¶ä½¿ç”¨ã€æµ‹è¯•ç”¨ä¾‹ç¼–å†™å’Œæµ‹è¯•æ‰§è¡ŒæŒ‡å—ã€‚ç¡®ä¿ç»„ä»¶åº“çš„è´¨é‡ã€ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  E2Eæµ‹è¯•     â”‚  â† å°‘é‡ï¼Œè¦†ç›–å…³é”®ç”¨æˆ·åœºæ™¯
        â”‚  (10%)       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ é›†æˆæµ‹è¯•     â”‚  â† ä¸­ç­‰æ•°é‡ï¼Œæµ‹è¯•ç»„ä»¶åä½œ
        â”‚ (30%)        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ å•å…ƒæµ‹è¯•     â”‚  â† å¤§é‡ï¼Œè¦†ç›–æ‰€æœ‰åŠŸèƒ½ç‚¹
        â”‚ (60%)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµ‹è¯•è¦†ç›–ç›®æ ‡

- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**: â‰¥ 90%
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**: â‰¥ 70%
- **E2Eæµ‹è¯•è¦†ç›–**: å…³é”®ä¸šåŠ¡æµç¨‹ 100%
- **å¯è®¿é—®æ€§æµ‹è¯•**: æ‰€æœ‰äº¤äº’ç»„ä»¶ 100%

### æµ‹è¯•åˆ†ç±»

| æµ‹è¯•ç±»å‹ | ç›®æ ‡ | å·¥å…· | æ‰§è¡Œé¢‘ç‡ |
|---------|------|------|---------|
| å•å…ƒæµ‹è¯• | ç»„ä»¶åŠŸèƒ½ã€å·¥å…·å‡½æ•°ã€Hooks | Jest + RTL | æ¯æ¬¡æäº¤ |
| å¿«ç…§æµ‹è¯• | ç»„ä»¶UIç»“æ„ | Jest | æ¯æ¬¡æäº¤ |
| é›†æˆæµ‹è¯• | ç»„ä»¶äº¤äº’ã€ä¸»é¢˜åˆ‡æ¢ | Jest + RTL | æ¯æ¬¡æäº¤ |
| å¯è®¿é—®æ€§æµ‹è¯• | ARIAã€é”®ç›˜å¯¼èˆª | jest-axe | æ¯æ¬¡æäº¤ |
| è§†è§‰å›å½’æµ‹è¯• | UIä¸€è‡´æ€§ | Percy/Chromatic | PRæ—¶ |
| E2Eæµ‹è¯• | ç”¨æˆ·æµç¨‹ | Playwright | å‘ç‰ˆå‰ |
| æ€§èƒ½æµ‹è¯• | æ¸²æŸ“æ€§èƒ½ã€å†…å­˜æ³„æ¼ | Lighthouse | å®šæœŸ |

## æµ‹è¯•æ¡†æ¶

### Jesté…ç½®

```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/packages'],
  testMatch: [
    '**/__tests__/**/*.test.ts?(x)',
    '**/?(*.)+(spec|test).ts?(x)'
  ],
  collectCoverageFrom: [
    'packages/*/src/**/*.{ts,tsx}',
    '!packages/*/src/**/*.stories.tsx',
    '!packages/*/src/**/*.d.ts',
    '!packages/*/src/**/index.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  },
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
  moduleNameMapper: {
    '\\.(css|less|scss)$': 'identity-obj-proxy',
    '^@chips-ui/(.*)$': '<rootDir>/packages/$1/src'
  },
  transform: {
    '^.+\\.tsx?$': ['ts-jest', {
      tsconfig: {
        jsx: 'react',
        esModuleInterop: true
      }
    }]
  }
};
```

### æµ‹è¯•ç¯å¢ƒé…ç½®

```typescript
// tests/setup.ts
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { toHaveNoViolations } from 'jest-axe';

// æ‰©å±•JeståŒ¹é…å™¨
expect.extend(toHaveNoViolations);

// æ¯ä¸ªæµ‹è¯•åæ¸…ç†
afterEach(() => {
  cleanup();
});

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(),
    removeListener: jest.fn(),
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});

// Mock IntersectionObserver
global.IntersectionObserver = class IntersectionObserver {
  constructor() {}
  disconnect() {}
  observe() {}
  takeRecords() { return []; }
  unobserve() {}
} as any;
```

### React Testing Libraryé…ç½®

```typescript
// tests/utils.tsx
import { render, RenderOptions } from '@testing-library/react';
import { ReactElement } from 'react';
import { ThemeProvider } from '@chips-ui/core';

// è‡ªå®šä¹‰æ¸²æŸ“å‡½æ•°ï¼ŒåŒ…å«Provider
interface CustomRenderOptions extends Omit<RenderOptions, 'wrapper'> {
  theme?: string;
}

export function renderWithTheme(
  ui: ReactElement,
  { theme = 'default', ...options }: CustomRenderOptions = {}
) {
  function Wrapper({ children }: { children: React.ReactNode }) {
    return (
      <ThemeProvider theme={theme}>
        {children}
      </ThemeProvider>
    );
  }

  return render(ui, { wrapper: Wrapper, ...options });
}

// é‡æ–°å¯¼å‡ºæ‰€æœ‰RTLå·¥å…·
export * from '@testing-library/react';
export { renderWithTheme as render };
```

## å•å…ƒæµ‹è¯•

### ç»„ä»¶æµ‹è¯•æ¨¡æ¿

```typescript
// Button.test.tsx
import { render, screen, fireEvent } from '@/tests/utils';
import { Button } from './Button';

describe('Button', () => {
  describe('æ¸²æŸ“æµ‹è¯•', () => {
    it('åº”è¯¥æ¸²æŸ“é»˜è®¤æŒ‰é’®', () => {
      render(<Button>ç‚¹å‡»æˆ‘</Button>);
      const button = screen.getByRole('button', { name: /ç‚¹å‡»æˆ‘/i });
      expect(button).toBeInTheDocument();
    });

    it('åº”è¯¥æ¸²æŸ“ä¸»è¦æŒ‰é’®', () => {
      render(<Button type="primary">ä¸»è¦æŒ‰é’®</Button>);
      const button = screen.getByRole('button');
      expect(button).toHaveClass('chips-button-primary');
    });

    it('åº”è¯¥æ¸²æŸ“ä¸åŒå°ºå¯¸', () => {
      const { rerender } = render(<Button size="small">å°æŒ‰é’®</Button>);
      expect(screen.getByRole('button')).toHaveClass('chips-button-small');

      rerender(<Button size="large">å¤§æŒ‰é’®</Button>);
      expect(screen.getByRole('button')).toHaveClass('chips-button-large');
    });
  });

  describe('äº¤äº’æµ‹è¯•', () => {
    it('åº”è¯¥å“åº”ç‚¹å‡»äº‹ä»¶', () => {
      const handleClick = jest.fn();
      render(<Button onClick={handleClick}>ç‚¹å‡»æˆ‘</Button>);
      
      fireEvent.click(screen.getByRole('button'));
      expect(handleClick).toHaveBeenCalledTimes(1);
    });

    it('ç¦ç”¨çŠ¶æ€ä¸‹ä¸åº”å“åº”ç‚¹å‡»', () => {
      const handleClick = jest.fn();
      render(<Button disabled onClick={handleClick}>ç¦ç”¨æŒ‰é’®</Button>);
      
      fireEvent.click(screen.getByRole('button'));
      expect(handleClick).not.toHaveBeenCalled();
    });

    it('åŠ è½½çŠ¶æ€ä¸‹ä¸åº”å“åº”ç‚¹å‡»', () => {
      const handleClick = jest.fn();
      render(<Button loading onClick={handleClick}>åŠ è½½ä¸­</Button>);
      
      fireEvent.click(screen.getByRole('button'));
      expect(handleClick).not.toHaveBeenCalled();
    });
  });

  describe('çŠ¶æ€æµ‹è¯•', () => {
    it('åº”è¯¥æ˜¾ç¤ºåŠ è½½å›¾æ ‡', () => {
      render(<Button loading>åŠ è½½ä¸­</Button>);
      expect(screen.getByRole('button')).toHaveClass('chips-button-loading');
    });

    it('åº”è¯¥æ˜¾ç¤ºè‡ªå®šä¹‰å›¾æ ‡', () => {
      render(<Button icon={<span data-testid="icon">ğŸ”¥</span>}>æŒ‰é’®</Button>);
      expect(screen.getByTestId('icon')).toBeInTheDocument();
    });
  });

  describe('PropséªŒè¯', () => {
    it('åº”è¯¥æ¥å—è‡ªå®šä¹‰ç±»å', () => {
      render(<Button className="custom-class">æŒ‰é’®</Button>);
      expect(screen.getByRole('button')).toHaveClass('custom-class');
    });

    it('åº”è¯¥æ”¯æŒdangerå±æ€§', () => {
      render(<Button danger>å±é™©æŒ‰é’®</Button>);
      expect(screen.getByRole('button')).toHaveClass('chips-button-danger');
    });

    it('åº”è¯¥æ”¯æŒhtmlType', () => {
      render(<Button htmlType="submit">æäº¤</Button>);
      expect(screen.getByRole('button')).toHaveAttribute('type', 'submit');
    });
  });
});
```

### Hooksæµ‹è¯•

```typescript
// useTheme.test.ts
import { renderHook, act } from '@testing-library/react';
import { ThemeProvider } from '../ThemeProvider';
import { useTheme } from './useTheme';

describe('useTheme', () => {
  it('åº”è¯¥è¿”å›å½“å‰ä¸»é¢˜', () => {
    const wrapper = ({ children }: any) => (
      <ThemeProvider theme="default">{children}</ThemeProvider>
    );

    const { result } = renderHook(() => useTheme(), { wrapper });
    expect(result.current.theme).toBe('default');
  });

  it('åº”è¯¥èƒ½åˆ‡æ¢ä¸»é¢˜', () => {
    const wrapper = ({ children }: any) => (
      <ThemeProvider theme="default">{children}</ThemeProvider>
    );

    const { result } = renderHook(() => useTheme(), { wrapper });

    act(() => {
      result.current.setTheme('dark');
    });

    expect(result.current.theme).toBe('dark');
  });
});
```

### å·¥å…·å‡½æ•°æµ‹è¯•

```typescript
// classNames.test.ts
import { classNames } from './classNames';

describe('classNames', () => {
  it('åº”è¯¥åˆå¹¶å­—ç¬¦ä¸²ç±»å', () => {
    expect(classNames('foo', 'bar')).toBe('foo bar');
  });

  it('åº”è¯¥å¤„ç†å¯¹è±¡ç±»å', () => {
    expect(classNames({ foo: true, bar: false })).toBe('foo');
  });

  it('åº”è¯¥å¤„ç†æ•°ç»„ç±»å', () => {
    expect(classNames(['foo', 'bar'])).toBe('foo bar');
  });

  it('åº”è¯¥è¿‡æ»¤falsyå€¼', () => {
    expect(classNames('foo', null, undefined, false, 'bar')).toBe('foo bar');
  });

  it('åº”è¯¥å¤„ç†æ··åˆç±»å‹', () => {
    expect(
      classNames('foo', { bar: true, baz: false }, ['qux', null])
    ).toBe('foo bar qux');
  });
});
```

## å¿«ç…§æµ‹è¯•

### ç»„ä»¶å¿«ç…§

```typescript
// Button.snapshot.test.tsx
import { render } from '@/tests/utils';
import { Button } from './Button';

describe('Button å¿«ç…§æµ‹è¯•', () => {
  it('é»˜è®¤æŒ‰é’®å¿«ç…§', () => {
    const { container } = render(<Button>é»˜è®¤æŒ‰é’®</Button>);
    expect(container.firstChild).toMatchSnapshot();
  });

  it('ä¸»è¦æŒ‰é’®å¿«ç…§', () => {
    const { container } = render(<Button type="primary">ä¸»è¦æŒ‰é’®</Button>);
    expect(container.firstChild).toMatchSnapshot();
  });

  it('ç¦ç”¨æŒ‰é’®å¿«ç…§', () => {
    const { container } = render(<Button disabled>ç¦ç”¨æŒ‰é’®</Button>);
    expect(container.firstChild).toMatchSnapshot();
  });

  it('åŠ è½½æŒ‰é’®å¿«ç…§', () => {
    const { container } = render(<Button loading>åŠ è½½æŒ‰é’®</Button>);
    expect(container.firstChild).toMatchSnapshot();
  });
});
```

### å¿«ç…§æ›´æ–°ç­–ç•¥

```bash
# æ›´æ–°æ‰€æœ‰å¿«ç…§
npm test -- -u

# æ›´æ–°ç‰¹å®šæ–‡ä»¶å¿«ç…§
npm test Button.snapshot.test.tsx -- -u

# äº¤äº’å¼æ›´æ–°å¿«ç…§
npm test -- --watch
```

## é›†æˆæµ‹è¯•

### ç»„ä»¶äº¤äº’æµ‹è¯•

```typescript
// Form.integration.test.tsx
import { render, screen, fireEvent, waitFor } from '@/tests/utils';
import { Form, Input, Button } from '@chips-ui/react';

describe('Form é›†æˆæµ‹è¯•', () => {
  it('åº”è¯¥å®Œæˆè¡¨å•æäº¤æµç¨‹', async () => {
    const handleSubmit = jest.fn();
    
    render(
      <Form onSubmit={handleSubmit}>
        <Form.Item name="username" label="ç”¨æˆ·å">
          <Input />
        </Form.Item>
        <Form.Item name="password" label="å¯†ç ">
          <Input type="password" />
        </Form.Item>
        <Button htmlType="submit">æäº¤</Button>
      </Form>
    );

    // å¡«å†™è¡¨å•
    fireEvent.change(screen.getByLabelText('ç”¨æˆ·å'), {
      target: { value: 'testuser' }
    });
    fireEvent.change(screen.getByLabelText('å¯†ç '), {
      target: { value: 'password123' }
    });

    // æäº¤è¡¨å•
    fireEvent.click(screen.getByRole('button', { name: /æäº¤/i }));

    await waitFor(() => {
      expect(handleSubmit).toHaveBeenCalledWith({
        username: 'testuser',
        password: 'password123'
      });
    });
  });

  it('åº”è¯¥æ˜¾ç¤ºè¡¨å•éªŒè¯é”™è¯¯', async () => {
    render(
      <Form>
        <Form.Item
          name="email"
          label="é‚®ç®±"
          rules={[{ required: true, message: 'è¯·è¾“å…¥é‚®ç®±' }]}
        >
          <Input />
        </Form.Item>
        <Button htmlType="submit">æäº¤</Button>
      </Form>
    );

    // ä¸å¡«å†™ç›´æ¥æäº¤
    fireEvent.click(screen.getByRole('button', { name: /æäº¤/i }));

    await waitFor(() => {
      expect(screen.getByText('è¯·è¾“å…¥é‚®ç®±')).toBeInTheDocument();
    });
  });
});
```

### ä¸»é¢˜åˆ‡æ¢æµ‹è¯•

```typescript
// ThemeSwitcher.integration.test.tsx
import { render, screen, fireEvent } from '@/tests/utils';
import { ThemeProvider, Button } from '@chips-ui/react';
import { useState } from 'react';

function ThemeSwitcherApp() {
  const [theme, setTheme] = useState('default');
  
  return (
    <ThemeProvider theme={theme}>
      <Button onClick={() => setTheme('dark')}>åˆ‡æ¢åˆ°æš—è‰²</Button>
      <div data-testid="content">å†…å®¹</div>
    </ThemeProvider>
  );
}

describe('ä¸»é¢˜åˆ‡æ¢æµ‹è¯•', () => {
  it('åº”è¯¥æˆåŠŸåˆ‡æ¢ä¸»é¢˜', () => {
    render(<ThemeSwitcherApp />);
    
    const content = screen.getByTestId('content');
    expect(content.closest('[data-chips-theme]')).toHaveAttribute(
      'data-chips-theme',
      'default'
    );

    fireEvent.click(screen.getByRole('button'));

    expect(content.closest('[data-chips-theme]')).toHaveAttribute(
      'data-chips-theme',
      'dark'
    );
  });
});
```

## å¯è®¿é—®æ€§æµ‹è¯•

### jest-axeæµ‹è¯•

```typescript
// Button.a11y.test.tsx
import { render } from '@/tests/utils';
import { axe } from 'jest-axe';
import { Button } from './Button';

describe('Button å¯è®¿é—®æ€§æµ‹è¯•', () => {
  it('åº”è¯¥æ²¡æœ‰å¯è®¿é—®æ€§è¿è§„', async () => {
    const { container } = render(<Button>æŒ‰é’®</Button>);
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('ç¦ç”¨æŒ‰é’®åº”è¯¥æ²¡æœ‰å¯è®¿é—®æ€§è¿è§„', async () => {
    const { container } = render(<Button disabled>ç¦ç”¨æŒ‰é’®</Button>);
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('åŠ è½½æŒ‰é’®åº”è¯¥æœ‰åˆé€‚çš„ariaå±æ€§', () => {
    render(<Button loading>åŠ è½½ä¸­</Button>);
    const button = screen.getByRole('button');
    expect(button).toHaveAttribute('aria-busy', 'true');
  });
});
```

### é”®ç›˜å¯¼èˆªæµ‹è¯•

```typescript
// Modal.keyboard.test.tsx
import { render, screen, fireEvent } from '@/tests/utils';
import { Modal } from './Modal';

describe('Modal é”®ç›˜å¯¼èˆªæµ‹è¯•', () => {
  it('åº”è¯¥æ”¯æŒESCé”®å…³é—­', () => {
    const handleClose = jest.fn();
    render(
      <Modal visible onCancel={handleClose}>
        <p>æ¨¡æ€æ¡†å†…å®¹</p>
      </Modal>
    );

    fireEvent.keyDown(document, { key: 'Escape' });
    expect(handleClose).toHaveBeenCalled();
  });

  it('åº”è¯¥æ”¯æŒTabé”®ç„¦ç‚¹ç®¡ç†', () => {
    render(
      <Modal visible>
        <button>æŒ‰é’®1</button>
        <button>æŒ‰é’®2</button>
      </Modal>
    );

    const button1 = screen.getByRole('button', { name: /æŒ‰é’®1/i });
    const button2 = screen.getByRole('button', { name: /æŒ‰é’®2/i });

    button1.focus();
    expect(document.activeElement).toBe(button1);

    fireEvent.keyDown(button1, { key: 'Tab' });
    expect(document.activeElement).toBe(button2);
  });
});
```

### ARIAå±æ€§æµ‹è¯•

```typescript
// Select.aria.test.tsx
import { render, screen } from '@/tests/utils';
import { Select } from './Select';

describe('Select ARIAæµ‹è¯•', () => {
  it('åº”è¯¥æœ‰æ­£ç¡®çš„role', () => {
    render(
      <Select options={[{ label: 'é€‰é¡¹1', value: '1' }]}>
        é€‰æ‹©å™¨
      </Select>
    );
    expect(screen.getByRole('combobox')).toBeInTheDocument();
  });

  it('åº”è¯¥æœ‰aria-expandedå±æ€§', () => {
    render(
      <Select options={[{ label: 'é€‰é¡¹1', value: '1' }]} />
    );
    const select = screen.getByRole('combobox');
    expect(select).toHaveAttribute('aria-expanded', 'false');
  });

  it('åº”è¯¥æœ‰aria-labelæˆ–aria-labelledby', () => {
    render(
      <Select
        aria-label="é€‰æ‹©ä¸€ä¸ªé€‰é¡¹"
        options={[{ label: 'é€‰é¡¹1', value: '1' }]}
      />
    );
    expect(screen.getByRole('combobox')).toHaveAttribute(
      'aria-label',
      'é€‰æ‹©ä¸€ä¸ªé€‰é¡¹'
    );
  });
});
```

## è§†è§‰å›å½’æµ‹è¯•

### Storybook + Chromatic

```typescript
// Button.stories.tsx
import type { Meta, StoryObj } from '@storybook/react';
import { Button } from './Button';

const meta: Meta<typeof Button> = {
  title: 'Components/Button',
  component: Button,
  parameters: {
    layout: 'centered',
  },
  tags: ['autodocs'],
};

export default meta;
type Story = StoryObj<typeof Button>;

export const Default: Story = {
  args: {
    children: 'é»˜è®¤æŒ‰é’®',
  },
};

export const Primary: Story = {
  args: {
    type: 'primary',
    children: 'ä¸»è¦æŒ‰é’®',
  },
};

export const AllVariants: Story = {
  render: () => (
    <div style={{ display: 'flex', gap: '8px', flexDirection: 'column' }}>
      <Button type="default">é»˜è®¤æŒ‰é’®</Button>
      <Button type="primary">ä¸»è¦æŒ‰é’®</Button>
      <Button type="dashed">è™šçº¿æŒ‰é’®</Button>
      <Button type="link">é“¾æ¥æŒ‰é’®</Button>
      <Button type="text">æ–‡æœ¬æŒ‰é’®</Button>
      <Button danger>å±é™©æŒ‰é’®</Button>
      <Button disabled>ç¦ç”¨æŒ‰é’®</Button>
      <Button loading>åŠ è½½æŒ‰é’®</Button>
    </div>
  ),
};
```

### Percyé…ç½®

```javascript
// .percy.yml
version: 2
static:
  include:
    - storybook-static
snapshots:
  widths:
    - 375
    - 768
    - 1280
  min-height: 1024
```

### Chromaticé…ç½®

```javascript
// .storybook/main.ts
import type { StorybookConfig } from '@storybook/react-vite';

const config: StorybookConfig = {
  stories: ['../packages/*/src/**/*.stories.@(js|jsx|ts|tsx)'],
  addons: [
    '@storybook/addon-links',
    '@storybook/addon-essentials',
    '@storybook/addon-interactions',
    '@storybook/addon-a11y',
  ],
  framework: {
    name: '@storybook/react-vite',
    options: {},
  },
};

export default config;
```

## æ€§èƒ½æµ‹è¯•

### æ¸²æŸ“æ€§èƒ½æµ‹è¯•

```typescript
// Button.perf.test.tsx
import { render } from '@/tests/utils';
import { Button } from './Button';

describe('Button æ€§èƒ½æµ‹è¯•', () => {
  it('åº”è¯¥åœ¨åˆç†æ—¶é—´å†…æ¸²æŸ“', () => {
    const startTime = performance.now();
    
    render(
      <div>
        {Array.from({ length: 100 }, (_, i) => (
          <Button key={i}>æŒ‰é’® {i}</Button>
        ))}
      </div>
    );
    
    const endTime = performance.now();
    const renderTime = endTime - startTime;
    
    expect(renderTime).toBeLessThan(100); // åº”åœ¨100mså†…å®Œæˆ
  });
});
```

### å†…å­˜æ³„æ¼æµ‹è¯•

```typescript
// Modal.memory.test.tsx
import { render, unmount } from '@/tests/utils';
import { Modal } from './Modal';

describe('Modal å†…å­˜æ³„æ¼æµ‹è¯•', () => {
  it('å¸è½½ååº”æ¸…ç†äº‹ä»¶ç›‘å¬å™¨', () => {
    const addEventListenerSpy = jest.spyOn(document, 'addEventListener');
    const removeEventListenerSpy = jest.spyOn(document, 'removeEventListener');
    
    const { unmount } = render(
      <Modal visible>
        <p>å†…å®¹</p>
      </Modal>
    );
    
    const addCount = addEventListenerSpy.mock.calls.length;
    
    unmount();
    
    const removeCount = removeEventListenerSpy.mock.calls.length;
    
    expect(removeCount).toBeGreaterThanOrEqual(addCount);
    
    addEventListenerSpy.mockRestore();
    removeEventListenerSpy.mockRestore();
  });
});
```

## E2Eæµ‹è¯•

### Playwrighté…ç½®

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

### E2Eæµ‹è¯•ç”¨ä¾‹

```typescript
// e2e/form-submission.spec.ts
import { test, expect } from '@playwright/test';

test.describe('è¡¨å•æäº¤æµç¨‹', () => {
  test('ç”¨æˆ·åº”è¯¥èƒ½å¤ŸæˆåŠŸæäº¤è¡¨å•', async ({ page }) => {
    await page.goto('/form-demo');

    // å¡«å†™è¡¨å•
    await page.fill('input[name="username"]', 'testuser');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('textarea[name="message"]', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯');

    // ç‚¹å‡»æäº¤æŒ‰é’®
    await page.click('button[type="submit"]');

    // ç­‰å¾…æˆåŠŸæç¤º
    await expect(page.locator('.chips-message-success')).toBeVisible();
    await expect(page.locator('.chips-message-success')).toContainText(
      'æäº¤æˆåŠŸ'
    );
  });

  test('åº”è¯¥æ˜¾ç¤ºéªŒè¯é”™è¯¯', async ({ page }) => {
    await page.goto('/form-demo');

    // ç›´æ¥ç‚¹å‡»æäº¤ï¼Œä¸å¡«å†™å¿…å¡«å­—æ®µ
    await page.click('button[type="submit"]');

    // æ£€æŸ¥é”™è¯¯æç¤º
    await expect(page.locator('.chips-form-item-error')).toHaveCount(2);
    await expect(page.locator('.chips-form-item-error').first()).toContainText(
      'è¯·è¾“å…¥ç”¨æˆ·å'
    );
  });
});
```

### ä¸»é¢˜åˆ‡æ¢E2Eæµ‹è¯•

```typescript
// e2e/theme-switching.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ä¸»é¢˜åˆ‡æ¢', () => {
  test('åº”è¯¥æˆåŠŸåˆ‡æ¢ä¸»é¢˜', async ({ page }) => {
    await page.goto('/');

    // æ£€æŸ¥é»˜è®¤ä¸»é¢˜
    const html = page.locator('html');
    await expect(html).toHaveAttribute('data-chips-theme', 'default');

    // ç‚¹å‡»ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
    await page.click('[data-testid="theme-switcher"]');
    await page.click('[data-testid="theme-option-dark"]');

    // æ£€æŸ¥ä¸»é¢˜å·²åˆ‡æ¢
    await expect(html).toHaveAttribute('data-chips-theme', 'dark');

    // éªŒè¯é¢œè‰²å˜åŒ–
    const button = page.locator('.chips-button-primary').first();
    const bgColor = await button.evaluate((el) =>
      window.getComputedStyle(el).backgroundColor
    );
    
    // æš—è‰²ä¸»é¢˜åº”è¯¥æœ‰ä¸åŒçš„èƒŒæ™¯è‰²
    expect(bgColor).not.toBe('rgb(24, 144, 255)');
  });
});
```

## æµ‹è¯•æ‰§è¡Œ

### æœ¬åœ°æ‰§è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæ–‡ä»¶çš„æµ‹è¯•
npm test Button.test.tsx

# ä»¥watchæ¨¡å¼è¿è¡Œ
npm test -- --watch

# è¿è¡Œè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
npm test -- --onlyFailures
```

### CI/CDé›†æˆ

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run unit tests
        run: pnpm test -- --coverage
      
      - name: Run E2E tests
        run: pnpm test:e2e
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
      
      - name: Run visual regression tests
        run: npx chromatic --project-token=${{ secrets.CHROMATIC_TOKEN }}
```

## æµ‹è¯•æŠ¥å‘Š

### è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage --coverageReporters=html

# æŸ¥çœ‹æŠ¥å‘Š
open coverage/index.html
```

### å¯è®¿é—®æ€§æŠ¥å‘Š

```typescript
// ç”Ÿæˆå¯è®¿é—®æ€§æŠ¥å‘Š
import { configureAxe } from 'jest-axe';

const axe = configureAxe({
  rules: {
    // è‡ªå®šä¹‰è§„åˆ™é…ç½®
  }
});

// ä¿å­˜æŠ¥å‘Š
const results = await axe(container);
fs.writeFileSync('a11y-report.json', JSON.stringify(results, null, 2));
```

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•ç»„ç»‡

- **æè¿°æ¸…æ™°**: ä½¿ç”¨æ¸…æ™°çš„describeå’Œitæè¿°
- **å•ä¸€èŒè´£**: æ¯ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹
- **ç‹¬ç«‹æ€§**: æµ‹è¯•ä¹‹é—´äº’ä¸ä¾èµ–
- **å¯é‡å¤**: æµ‹è¯•ç»“æœå¯é‡å¤

### 2. æµ‹è¯•æ•°æ®

```typescript
// ä½¿ç”¨æµ‹è¯•å·¥å‚åˆ›å»ºæ•°æ®
function createUser(overrides = {}) {
  return {
    id: '1',
    name: 'Test User',
    email: 'test@example.com',
    ...overrides
  };
}

// æµ‹è¯•ä¸­ä½¿ç”¨
const user = createUser({ name: 'Custom Name' });
```

### 3. Mockç­–ç•¥

```typescript
// Mock APIè°ƒç”¨
jest.mock('@chips-ui/sdk', () => ({
  fetchUser: jest.fn(() => Promise.resolve({
    id: '1',
    name: 'Test User'
  }))
}));

// Mockå®šæ—¶å™¨
jest.useFakeTimers();
jest.advanceTimersByTime(1000);
jest.useRealTimers();
```

### 4. å¼‚æ­¥æµ‹è¯•

```typescript
// ä½¿ç”¨waitForç­‰å¾…å¼‚æ­¥æ›´æ–°
await waitFor(() => {
  expect(screen.getByText('åŠ è½½å®Œæˆ')).toBeInTheDocument();
});

// ä½¿ç”¨findByæŸ¥è¯¢ï¼ˆå†…ç½®ç­‰å¾…ï¼‰
const element = await screen.findByText('åŠ è½½å®Œæˆ');
expect(element).toBeInTheDocument();
```

### 5. æµ‹è¯•è¦†ç›–

- **æ­£å¸¸è·¯å¾„**: æµ‹è¯•æ­£å¸¸çš„ç”¨æˆ·æµç¨‹
- **è¾¹ç•Œæƒ…å†µ**: æµ‹è¯•è¾¹ç•Œå€¼å’Œæç«¯æƒ…å†µ
- **é”™è¯¯å¤„ç†**: æµ‹è¯•é”™è¯¯æƒ…å†µå’Œæ¢å¤
- **äº¤äº’æµç¨‹**: æµ‹è¯•ç”¨æˆ·äº¤äº’åœºæ™¯

## æµ‹è¯•ç»´æŠ¤

### å®šæœŸå®¡æŸ¥

- æ¯æœˆå®¡æŸ¥æµ‹è¯•è¦†ç›–ç‡
- æ¸…ç†è¿‡æ—¶çš„æµ‹è¯•
- æ›´æ–°å¤±æ•ˆçš„å¿«ç…§
- ä¼˜åŒ–æ…¢é€Ÿæµ‹è¯•

### æŒç»­æ”¹è¿›

- æ ¹æ®bugè¡¥å……æµ‹è¯•ç”¨ä¾‹
- æé«˜æµ‹è¯•å¯è¯»æ€§
- å‡å°‘æµ‹è¯•è€¦åˆ
- ä¼˜åŒ–æµ‹è¯•æ€§èƒ½

## æ€»ç»“

å®Œå–„çš„æµ‹è¯•ä½“ç³»æ˜¯ç¡®ä¿ç»„ä»¶åº“è´¨é‡çš„å…³é”®ã€‚é€šè¿‡å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•ã€å¯è®¿é—®æ€§æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•çš„å…¨é¢è¦†ç›–ï¼Œç¡®ä¿ç»„ä»¶åº“çš„åŠŸèƒ½æ­£ç¡®ã€æ€§èƒ½ä¼˜ç§€ã€å¯è®¿é—®æ€§è‰¯å¥½ã€‚éµå¾ªæµ‹è¯•æœ€ä½³å®è·µï¼ŒæŒç»­ç»´æŠ¤å’Œæ”¹è¿›æµ‹è¯•ç”¨ä¾‹ï¼Œä¸ºç»„ä»¶åº“çš„é•¿æœŸå‘å±•æä¾›åšå®ä¿éšœã€‚
