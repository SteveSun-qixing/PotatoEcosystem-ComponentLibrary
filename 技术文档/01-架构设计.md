# 前端组件库架构设计

## 架构概述

Chips前端组件库采用分层架构，彻底分离功能逻辑和视觉样式，通过清晰的接口定义实现组件、主题、内核之间的解耦。整体架构遵循薯片生态的极致模块化理念，确保每个部分都可以独立开发、测试和替换。

## 核心架构原则

### 1. 功能与样式完全分离

**功能层**
- 组件只包含功能逻辑代码
- 实现用户交互处理
- 管理组件状态
- 处理数据绑定
- 触发事件和回调

**布局层**
- 定义DOM结构
- 定义元素层级关系
- 使用Flexbox/Grid等布局技术
- 不包含任何视觉样式属性

**样式层**
- 完全由主题包提供
- 通过样式接口点注入
- CSS变量驱动
- 支持动态切换

### 2. 标准化接口

**对外接口**
- 统一的Props接口定义
- 统一的事件接口定义
- 统一的样式接口点定义
- 完整的TypeScript类型定义

**对内核接口**
- 通过SDK调用内核API
- 遵循前端接口标准
- 标准化的请求响应格式
- 事件订阅和推送机制

**对主题接口**
- 暴露约定的类名
- 提供CSS变量注入点
- 定义样式覆盖优先级
- 支持主题嵌套

### 3. 模块化设计

**组件独立性**
- 每个组件独立开发
- 组件之间松耦合
- 通过明确接口组合
- 支持按需加载

**功能分层**
- 基础组件：原子级功能单元
- 布局组件：空间组织单元
- 组合组件：业务级复合组件
- 卡片组件：卡片渲染专用组件

**工具分离**
- 工具函数独立模块
- Hooks独立模块
- 类型定义独立模块
- 常量定义独立模块

### 4. 可扩展架构

**插件机制**
- 支持注册自定义组件
- 支持扩展现有组件
- 支持注入自定义逻辑
- 支持第三方集成

**框架适配**
- 核心层框架无关
- 适配层对接具体框架
- 支持多框架实现
- 适配层可独立开发

## 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         应用层                                │
│              (使用组件库构建的薯片应用)                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                    基础卡片插件层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 视频卡片插件  │  │Markdown插件  │  │ 图片卡片插件  │      │
│  │  (渲染组件)  │  │  (渲染组件)  │  │  (渲染组件)  │      │
│  │  (编辑组件)  │  │  (编辑组件)  │  │  (编辑组件)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  注：基础卡片组件在各自的插件中实现，不属于组件库            │
└─────────────────────┬───────────────────────────────────────┘
                      │ 可选使用
┌─────────────────────┴───────────────────────────────────────┐
│                    组件库核心层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  基础组件库   │  │  布局组件库   │  │ 卡片辅助组件  │      │
│  │              │  │              │  │              │      │
│  │ Button       │  │ Grid         │  │ CardWrapper  │      │
│  │ Input        │  │ Flex         │  │ CardLoading  │      │
│  │ Select       │  │ Container    │  │ CardError    │      │
│  │ ...          │  │ ...          │  │ ...          │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  表单组件库   │  │  特殊组件库   │  │  数据组件库   │      │
│  │              │  │              │  │              │      │
│  │ Form         │  │ThemeProvider │  │ Table        │      │
│  │ FormItem     │  │ChipsProvider │  │ List         │      │
│  │ ...          │  │ErrorBoundary │  │ Tree         │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                    核心抽象层                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              组件基类和工具                            │   │
│  │  • Component Base Class                              │   │
│  │  • Hooks Library (useState, useEffect, useTheme...)  │   │
│  │  • Utils (classNames, mergeRefs, composeEventHandlers)│  │
│  │  • Constants (component names, prop types)           │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              主题系统                                  │   │
│  │  • Theme Context                                      │   │
│  │  • Theme Provider                                     │   │
│  │  • Style Interface Manager                            │   │
│  │  • CSS Variable Injector                              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              内核通信层                                │   │
│  │  • SDK Integration                                    │   │
│  │  • Request/Response Handlers                          │   │
│  │  • Event Subscription Manager                         │   │
│  │  • State Synchronization                              │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                   Vue 3 实现层                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Vue 3 + TypeScript + Composition API                  │ │
│  │  • 使用 <script setup> 语法                            │ │
│  │  • 使用 Composables (useTheme, useI18n, ...)          │ │
│  │  • 无样式组件（样式由主题包提供）                       │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                   外部依赖层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  薯片内核SDK  │  │  Vue 3       │  │  主题包       │      │
│  │              │  │              │  │              │      │
│  │ Chips SDK    │  │ Vue 3.4+     │  │ Theme Package│      │
│  │              │  │ TypeScript   │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

> **技术选型说明**：薯片组件库使用 Vue 3 + TypeScript 作为实现框架。组件库是基于 Vue 3 开发的无样式组件库，类似于 Element Plus、Arco Design Vue 的定位，但不包含样式代码，样式完全由主题包提供。

## 核心模块设计

### 组件核心模块

#### 组件基类（Component Base）

所有组件继承或遵循的基础接口：

```typescript
interface ChipsComponentBase {
  // 组件标识
  readonly componentName: string;
  
  // 样式接口点
  readonly styleInterfaces: StyleInterface[];
  
  // Props定义
  props: ComponentProps;
  
  // 状态管理
  state: ComponentState;
  
  // 生命周期
  onMount?(): void;
  onUpdate?(): void;
  onUnmount?(): void;
  
  // 事件处理
  emit(eventName: string, data: any): void;
  on(eventName: string, handler: Function): void;
  off(eventName: string, handler: Function): void;
  
  // 主题相关
  getTheme(): Theme;
  applyTheme(theme: Theme): void;
}
```

#### 样式接口管理器

管理组件的样式接口点：

```typescript
interface StyleInterfaceManager {
  // 注册样式接口点
  registerInterface(name: string, element: HTMLElement): void;
  
  // 获取样式接口点
  getInterface(name: string): HTMLElement | null;
  
  // 应用样式类
  applyClasses(name: string, classes: string[]): void;
  
  // 应用CSS变量
  applyVariables(name: string, variables: Record<string, string>): void;
  
  // 清除样式
  clearStyles(name: string): void;
}
```

### 主题系统模块

#### 主题上下文（Theme Context）

提供主题的全局上下文：

```typescript
interface ThemeContext {
  // 当前主题
  currentTheme: Theme;
  
  // 主题栈（支持嵌套）
  themeStack: Theme[];
  
  // 设置主题
  setTheme(theme: Theme): void;
  
  // 推入主题（嵌套）
  pushTheme(theme: Theme): void;
  
  // 弹出主题
  popTheme(): void;
  
  // 获取有效主题（考虑层级）
  getEffectiveTheme(component: Component): Theme;
  
  // 主题变化监听
  onThemeChange(callback: (theme: Theme) => void): void;
}
```

#### 主题加载器（Theme Loader）

负责加载和管理主题包：

```typescript
interface ThemeLoader {
  // 加载主题包
  loadTheme(themeId: string): Promise<Theme>;
  
  // 卸载主题包
  unloadTheme(themeId: string): void;
  
  // 获取已加载的主题
  getLoadedTheme(themeId: string): Theme | null;
  
  // 预加载主题
  preloadTheme(themeId: string): Promise<void>;
  
  // 验证主题完整性
  validateTheme(theme: Theme): boolean;
}
```

#### CSS变量注入器

注入主题的CSS变量：

```typescript
interface CSSVariableInjector {
  // 注入变量到作用域
  inject(scope: HTMLElement, variables: Record<string, string>): void;
  
  // 移除变量
  remove(scope: HTMLElement): void;
  
  // 更新变量
  update(scope: HTMLElement, variables: Record<string, string>): void;
  
  // 获取变量值
  getValue(scope: HTMLElement, variableName: string): string;
}
```

### 内核通信模块

#### SDK集成层

封装对薯片内核SDK的调用：

```typescript
interface SDKIntegration {
  // 初始化SDK连接
  initialize(config: SDKConfig): Promise<void>;
  
  // 调用内核API
  call(method: string, params: any): Promise<any>;
  
  // 订阅事件
  subscribe(eventType: string, handler: Function): void;
  
  // 取消订阅
  unsubscribe(eventType: string, handler: Function): void;
  
  // 获取连接状态
  getConnectionStatus(): ConnectionStatus;
  
  // 断开连接
  disconnect(): void;
}
```

#### 请求管理器

管理前端到后端的请求：

```typescript
interface RequestManager {
  // 发送请求
  send(request: Request): Promise<Response>;
  
  // 批量请求
  batch(requests: Request[]): Promise<Response[]>;
  
  // 取消请求
  cancel(requestId: string): void;
  
  // 重试请求
  retry(requestId: string): Promise<Response>;
  
  // 请求拦截器
  addInterceptor(interceptor: Interceptor): void;
  
  // 请求缓存
  getCachedResponse(request: Request): Response | null;
}
```

#### 事件管理器

管理内核推送的事件：

```typescript
interface EventManager {
  // 注册事件监听器
  on(eventType: string, handler: EventHandler): void;
  
  // 移除事件监听器
  off(eventType: string, handler: EventHandler): void;
  
  // 触发一次性监听器
  once(eventType: string, handler: EventHandler): void;
  
  // 触发事件（用于测试）
  emit(event: Event): void;
  
  // 过滤事件
  filter(predicate: (event: Event) => boolean): void;
}
```

### 状态管理模块

#### 组件状态管理

管理组件自身状态：

```typescript
interface ComponentStateManager {
  // 获取状态
  getState(key: string): any;
  
  // 设置状态
  setState(key: string, value: any): void;
  
  // 批量更新状态
  batchUpdate(updates: Record<string, any>): void;
  
  // 监听状态变化
  watch(key: string, handler: (value: any) => void): void;
  
  // 计算属性
  computed(key: string, getter: () => any): any;
}
```

#### 全局状态管理

管理跨组件的共享状态：

```typescript
interface GlobalStateManager {
  // 创建全局状态
  createState<T>(key: string, initialValue: T): State<T>;
  
  // 获取全局状态
  getState<T>(key: string): State<T>;
  
  // 订阅状态变化
  subscribe<T>(key: string, handler: (value: T) => void): void;
  
  // 派发动作
  dispatch(action: Action): void;
  
  // 中间件
  use(middleware: Middleware): void;
}
```

### 工具模块

#### 类名工具

处理动态类名：

```typescript
function classNames(...args: ClassValue[]): string;

// 使用示例
classNames('button', { 'button-primary': isPrimary, 'button-disabled': disabled });
```

#### Ref合并工具

合并多个ref：

```typescript
function mergeRefs<T>(...refs: React.Ref<T>[]): React.RefCallback<T>;
```

#### 事件组合工具

组合多个事件处理器：

```typescript
function composeEventHandlers<E>(
  externalHandler?: (event: E) => void,
  internalHandler?: (event: E) => void
): (event: E) => void;
```

#### 防抖和节流

性能优化工具：

```typescript
function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): T;

function throttle<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): T;
```

## 框架适配层设计

### React适配层

#### Hooks封装

```typescript
// 主题Hook
function useTheme(): Theme;

// 内核通信Hook
function useKernel(): {
  call: (method: string, params: any) => Promise<any>;
  subscribe: (eventType: string) => any;
};

// 状态Hook
function useChipsState<T>(key: string, initialValue: T): [T, (value: T) => void];

// 表单Hook
function useForm(config: FormConfig): FormInstance;
```

#### 组件封装

将核心组件封装为React组件：

```typescript
// 高阶组件
function withTheme<P>(Component: React.ComponentType<P>): React.ComponentType<P>;

// 组件包装器
function wrapChipsComponent(ChipsComponent: ChipsComponent): React.FC;
```

### Vue适配层

#### Composition API封装

```typescript
// 主题Composition
function useTheme(): { theme: Ref<Theme>, setTheme: (theme: Theme) => void };

// 内核通信Composition
function useKernel(): KernelAPI;

// 状态Composition
function useChipsState<T>(key: string, initialValue: T): StateRef<T>;
```

#### 组件封装

将核心组件封装为Vue组件：

```typescript
// 组件包装器
function wrapChipsComponent(ChipsComponent: ChipsComponent): DefineComponent;

// 指令
function vTheme(el: HTMLElement, binding: DirectiveBinding): void;
```

### Svelte适配层

#### Store封装

```typescript
// 主题Store
const theme: Writable<Theme>;

// 内核Store
const kernel: Readable<KernelConnection>;

// 状态Store
function createChipsStore<T>(key: string, initialValue: T): Writable<T>;
```

## 性能优化架构

### 按需加载

- 组件代码分割
- 动态导入组件
- 路由级别懒加载
- 主题包按需加载

### 虚拟化

- 长列表虚拟滚动
- 大数据表格虚拟化
- 树形结构虚拟渲染

### 缓存策略

- 组件缓存
- 请求响应缓存
- 主题包缓存
- 资源预加载

### 渲染优化

- 避免不必要的重渲染
- 使用React.memo/Vue.memo
- 优化状态更新
- 批量更新DOM

## 扩展性设计

### 插件系统

```typescript
interface Plugin {
  name: string;
  version: string;
  install(app: ChipsApp): void;
  uninstall?(app: ChipsApp): void;
}

// 注册插件
app.use(plugin);
```

### 组件注册

```typescript
// 注册全局组件
app.component('CustomButton', CustomButton);

// 注册局部组件
import { CustomButton } from './components';
```

### 主题扩展

```typescript
// 扩展主题
const extendedTheme = extendTheme(baseTheme, {
  colors: {
    primary: '#custom-color'
  }
});
```

## 测试架构

### 单元测试

- 组件逻辑测试
- 工具函数测试
- Hooks测试
- 状态管理测试

### 集成测试

- 组件交互测试
- 主题切换测试
- 内核通信测试
- 表单提交流程测试

### E2E测试

- 用户场景测试
- 跨组件交互测试
- 性能测试
- 视觉回归测试

## 文档架构

### API文档

- 组件API自动生成
- Props类型文档
- 事件文档
- 方法文档

### 示例文档

- 基础用法示例
- 高级用法示例
- 最佳实践示例
- 问题排查示例

### 开发文档

- 架构设计文档
- 开发指南
- 贡献指南
- 发布流程

## 安全架构

### XSS防护

- 输入内容转义
- 危险HTML过滤
- CSP策略设置

### CSRF防护

- Token验证
- 同源检查
- 安全的Cookie设置

### 权限控制

- 组件级权限控制
- 操作权限验证
- 数据访问权限

## 多语言架构

### 系统统一的多语言方案

前端组件库完全采用薯片生态的系统统一多语言方案，核心特点：

- **零硬编码原则**：组件代码中不允许出现任何明文字符串
- **系统接管显示**：所有文本由系统多语言引擎统一管理和显示
- **开发时使用key**：开发阶段使用人类可读的词汇key
- **打包时替换编码**：构建时自动将key替换为系统词汇编码
- **配置表管理**：所有文本必须在配置表中定义

> **完整规范**: 详见 [多语言系统规范](../../生态共用/11-多语言系统规范.md)

### 多语言接口

```typescript
interface I18n {
  // 设置语言
  setLocale(locale: string): void;
  
  // 获取当前语言
  getLocale(): string;
  
  // 翻译文本（使用词汇编码）
  // 开发时使用key: t('common.ok')
  // 打包后自动替换为: t('i18n.core.000001')
  t(code: string, vars?: Record<string, any>): string;
  
  // 注册插件词汇表
  registerVocabulary(vocabulary: VocabularyMap): void;
  
  // 监听语言切换
  onLocaleChange(callback: (locale: string) => void): void;
}
```

### 开发时用法

```typescript
import { useTranslation } from '@chips/i18n';

function MyComponent() {
  const { t } = useTranslation();
  
  return (
    <div>
      {/* 开发时使用清晰的key */}
      <button>{t('common.ok')}</button>
      <button>{t('common.cancel')}</button>
      
      {/* 支持变量插值 */}
      <p>{t('ui.file_count', { count: 10 })}</p>
    </div>
  );
}
```

### 开发阶段词汇表

在项目中维护 `dev_i18n.yaml`：

```yaml
common:
  ok: "确定"
  cancel: "取消"
  save: "保存"
  delete: "删除"

ui:
  loading: "加载中..."
  file_count: "共 {count} 个文件"
  empty_state: "暂无数据"
```

### 打包时自动替换

构建工具会自动将开发用的key替换为系统词汇编码：

```typescript
// 打包前
<button>{t('common.ok')}</button>

// 打包后
<button>{t('i18n.core.000001')}</button>
```

### 词汇编码范围

前端组件使用的词汇编码：

| 编码前缀 | 范围 | 用途 |
|---------|-----|------|
| `i18n.core.` | 000001-099999 | 核心系统词汇 |
| `i18n.ui.` | 100000-199999 | UI组件通用词汇 |
| `i18n.editor.` | 200000-299999 | 编辑器词汇 |
| `i18n.viewer.` | 300000-399999 | 查看器词汇 |

### 格式化功能

多语言系统提供标准格式化功能：

- **日期时间格式化**：根据语言环境自动格式化
- **数字格式化**：千分位、小数点等本地化处理
- **货币格式化**：货币符号和格式本地化
- **相对时间**：如"3分钟前"、"2天后"等

```typescript
import { useTranslation } from '@chips/i18n';

function DateDisplay() {
  const { formatDate, formatNumber } = useTranslation();
  
  return (
    <div>
      <p>{formatDate(new Date(), 'long')}</p>
      <p>{formatNumber(1234567.89)}</p>
    </div>
  );
}
```

### 最佳实践

1. **复用系统词汇**：优先使用系统已有的词汇编码
2. **清晰的key命名**：使用有意义的、层次清晰的key名称
3. **避免重复**：查阅系统词汇表，避免重复定义
4. **上下文明确**：key应该能体现使用场景和上下文
5. **变量命名规范**：插值变量使用清晰的名称

## 无障碍架构

### ARIA支持

- 语义化HTML
- ARIA属性
- 角色定义
- 状态和属性

### 键盘导航

- Tab导航
- 方向键导航
- 快捷键支持
- 焦点管理

### 屏幕阅读器

- 朗读文本优化
- 动态内容通知
- 表单标签关联

## 总结

Chips前端组件库采用清晰的分层架构，通过功能与样式的完全分离、标准化的接口设计、模块化的组件组织，实现了高度的灵活性和可扩展性。核心层保持框架无关，通过适配层支持多种前端框架。主题系统、内核通信、状态管理等核心模块提供了完整的基础设施。整体架构既保证了当前的功能需求，也为未来的扩展和演进留下了充分的空间。
