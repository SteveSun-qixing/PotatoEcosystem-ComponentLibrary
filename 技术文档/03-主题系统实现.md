# 主题系统实现

## 主题系统概述

主题系统是薯片前端组件库的核心特性,负责整个视觉层的实现。组件库通过暴露样式接口点,让主题包可以注入完整的视觉实现。主题系统支持原子级应用、层级覆盖、动态切换,实现了功能与样式的彻底分离。

## 核心机制

### CSS变量驱动

主题系统使用CSS自定义属性(CSS Variables)作为核心机制:

**设计Tokens定义**
```css
/* 主题包定义设计tokens */
:root {
  /* 颜色系统 */
  --chips-color-primary: #1890ff;
  --chips-color-success: #52c41a;
  --chips-color-warning: #faad14;
  --chips-color-error: #f5222d;
  --chips-color-text-primary: rgba(0, 0, 0, 0.85);
  --chips-color-text-secondary: rgba(0, 0, 0, 0.65);
  --chips-color-bg-base: #ffffff;
  --chips-color-border: #d9d9d9;
  
  /* 字体系统 */
  --chips-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
  --chips-font-size-xs: 12px;
  --chips-font-size-sm: 14px;
  --chips-font-size-base: 16px;
  --chips-font-size-lg: 18px;
  --chips-font-size-xl: 20px;
  --chips-font-weight-normal: 400;
  --chips-font-weight-medium: 500;
  --chips-font-weight-bold: 600;
  --chips-line-height-base: 1.5;
  
  /* 间距系统 */
  --chips-spacing-xs: 4px;
  --chips-spacing-sm: 8px;
  --chips-spacing-base: 12px;
  --chips-spacing-md: 16px;
  --chips-spacing-lg: 24px;
  --chips-spacing-xl: 32px;
  
  /* 圆角系统 */
  --chips-border-radius-sm: 2px;
  --chips-border-radius-base: 4px;
  --chips-border-radius-lg: 8px;
  --chips-border-radius-full: 9999px;
  
  /* 阴影系统 */
  --chips-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --chips-shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  --chips-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --chips-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  
  /* 过渡动画 */
  --chips-transition-fast: 150ms;
  --chips-transition-base: 300ms;
  --chips-transition-slow: 500ms;
  --chips-transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
  
  /* 组件特定变量 */
  --chips-button-height-sm: 24px;
  --chips-button-height-base: 32px;
  --chips-button-height-lg: 40px;
  --chips-button-padding-horizontal: 15px;
}
```

**组件使用变量**
```css
/* 组件样式引用变量 */
.chips-button {
  height: var(--chips-button-height-base);
  padding: 0 var(--chips-button-padding-horizontal);
  font-size: var(--chips-font-size-base);
  font-weight: var(--chips-font-weight-medium);
  line-height: var(--chips-line-height-base);
  border-radius: var(--chips-border-radius-base);
  transition: all var(--chips-transition-base) var(--chips-transition-timing);
}

.chips-button-primary {
  background-color: var(--chips-color-primary);
  color: #ffffff;
  border: 1px solid var(--chips-color-primary);
}

.chips-button-sm {
  height: var(--chips-button-height-sm);
  font-size: var(--chips-font-size-sm);
}

.chips-button-lg {
  height: var(--chips-button-height-lg);
  font-size: var(--chips-font-size-lg);
}
```

### 主题作用域

通过数据属性控制主题作用域:

```html
<!-- 全局主题 -->
<html data-chips-theme="default">
  <!-- 所有内容使用default主题 -->
  
  <!-- 局部主题覆盖 -->
  <div data-chips-theme="dark">
    <!-- 这个区域使用dark主题 -->
    
    <!-- 进一步嵌套 -->
    <div data-chips-theme="macaron">
      <!-- 这个区域使用macaron主题 -->
    </div>
  </div>
</html>
```

```css
/* 主题作用域样式 */
[data-chips-theme="dark"] {
  --chips-color-bg-base: #141414;
  --chips-color-text-primary: rgba(255, 255, 255, 0.85);
  --chips-color-border: #434343;
}

[data-chips-theme="macaron"] {
  --chips-color-primary: #ff6b9d;
  --chips-color-success: #97ce68;
  --chips-color-warning: #ffa940;
}
```

## 主题包结构

### 主题包文件组织

```
theme-macaron/
├── package.json           # 主题包元数据
├── README.md             # 主题包说明
├── preview.png           # 预览图
├── src/
│   ├── tokens.css        # 设计tokens定义
│   ├── base.css          # 全局基础样式
│   ├── components/       # 组件样式
│   │   ├── button.css
│   │   ├── input.css
│   │   ├── select.css
│   │   └── ...
│   ├── cards/            # 卡片样式
│   │   ├── markdown.css
│   │   ├── image.css
│   │   └── ...
│   └── index.css         # 样式入口
└── dist/                 # 构建输出
    ├── index.css         # 打包后的完整样式
    └── index.min.css     # 压缩版本
```

### 主题包元数据

```json
{
  "name": "@chips-theme/macaron",
  "version": "1.0.0",
  "description": "马卡龙配色主题",
  "author": "Chips Team",
  "license": "MIT",
  "chipsTheme": {
    "id": "macaron",
    "displayName": "马卡龙配色",
    "preview": "./preview.png",
    "category": "colorful",
    "tags": ["可爱", "彩色", "柔和"],
    "compatibility": {
      "minVersion": "1.0.0",
      "maxVersion": "2.x"
    }
  },
  "main": "dist/index.css",
  "files": ["dist", "src", "preview.png"],
  "scripts": {
    "build": "postcss src/index.css -o dist/index.css",
    "build:min": "postcss src/index.css -o dist/index.min.css --env production"
  }
}
```

### 主题包入口文件

```css
/* src/index.css */

/* 设计tokens */
@import './tokens.css';

/* 全局基础样式 */
@import './base.css';

/* 组件样式 */
@import './components/button.css';
@import './components/input.css';
@import './components/select.css';
/* ... 更多组件 */

/* 卡片样式 */
@import './cards/markdown.css';
@import './cards/image.css';
/* ... 更多卡片 */
```

## 主题注入实现

### ThemeProvider组件

```typescript
interface ThemeProviderProps {
  theme: string | Theme;     // 主题ID或主题对象
  children: ReactNode;
}

export function ThemeProvider({ theme, children }: ThemeProviderProps) {
  const themeId = typeof theme === 'string' ? theme : theme.id;
  const themeRef = useRef<HTMLDivElement>(null);
  
  // 加载主题样式
  useEffect(() => {
    const loadTheme = async () => {
      const themeStyles = await themeLoader.load(themeId);
      if (themeRef.current) {
        // 注入主题样式
        injectThemeStyles(themeRef.current, themeStyles);
      }
    };
    
    loadTheme();
    
    return () => {
      // 清理主题样式
      if (themeRef.current) {
        cleanupThemeStyles(themeRef.current);
      }
    };
  }, [themeId]);
  
  return (
    <div 
      ref={themeRef}
      data-chips-theme={themeId}
      className="chips-theme-container"
    >
      {children}
    </div>
  );
}
```

### 主题加载器

```typescript
class ThemeLoader {
  private loadedThemes = new Map<string, Theme>();
  private loadingPromises = new Map<string, Promise<Theme>>();
  
  /**
   * 加载主题包
   */
  async load(themeId: string): Promise<Theme> {
    // 如果已加载,直接返回
    if (this.loadedThemes.has(themeId)) {
      return this.loadedThemes.get(themeId)!;
    }
    
    // 如果正在加载,返回现有Promise
    if (this.loadingPromises.has(themeId)) {
      return this.loadingPromises.get(themeId)!;
    }
    
    // 开始加载
    const promise = this.loadThemeInternal(themeId);
    this.loadingPromises.set(themeId, promise);
    
    try {
      const theme = await promise;
      this.loadedThemes.set(themeId, theme);
      return theme;
    } finally {
      this.loadingPromises.delete(themeId);
    }
  }
  
  private async loadThemeInternal(themeId: string): Promise<Theme> {
    // 从注册表获取主题信息
    const themeInfo = await this.fetchThemeInfo(themeId);
    
    // 加载主题CSS文件
    const cssUrl = themeInfo.cssUrl;
    await this.loadCSS(cssUrl);
    
    // 解析主题变量
    const variables = await this.extractVariables(themeId);
    
    return {
      id: themeId,
      name: themeInfo.name,
      variables,
      cssUrl
    };
  }
  
  /**
   * 加载CSS文件
   */
  private loadCSS(url: string): Promise<void> {
    return new Promise((resolve, reject) => {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      link.onload = () => resolve();
      link.onerror = () => reject(new Error(`Failed to load CSS: ${url}`));
      document.head.appendChild(link);
    });
  }
  
  /**
   * 提取主题CSS变量
   */
  private async extractVariables(themeId: string): Promise<Record<string, string>> {
    const container = document.querySelector(`[data-chips-theme="${themeId}"]`);
    if (!container) return {};
    
    const computedStyle = getComputedStyle(container as Element);
    const variables: Record<string, string> = {};
    
    // 提取所有chips-开头的变量
    for (let i = 0; i < computedStyle.length; i++) {
      const prop = computedStyle[i];
      if (prop.startsWith('--chips-')) {
        variables[prop] = computedStyle.getPropertyValue(prop).trim();
      }
    }
    
    return variables;
  }
  
  /**
   * 卸载主题
   */
  unload(themeId: string): void {
    this.loadedThemes.delete(themeId);
    // 移除对应的CSS link标签
    const links = document.querySelectorAll(`link[data-theme-id="${themeId}"]`);
    links.forEach(link => link.remove());
  }
}

export const themeLoader = new ThemeLoader();
```

### CSS变量注入器

```typescript
/**
 * 注入CSS变量到指定元素
 */
export function injectCSSVariables(
  element: HTMLElement,
  variables: Record<string, string>
): void {
  Object.entries(variables).forEach(([name, value]) => {
    element.style.setProperty(name, value);
  });
}

/**
 * 移除CSS变量
 */
export function removeCSSVariables(
  element: HTMLElement,
  variableNames: string[]
): void {
  variableNames.forEach(name => {
    element.style.removeProperty(name);
  });
}

/**
 * 获取CSS变量值
 */
export function getCSSVariable(
  element: HTMLElement,
  variableName: string
): string {
  return getComputedStyle(element).getPropertyValue(variableName).trim();
}

/**
 * 批量更新CSS变量
 */
export function updateCSSVariables(
  element: HTMLElement,
  updates: Record<string, string>
): void {
  // 使用requestAnimationFrame批量更新,避免重排
  requestAnimationFrame(() => {
    Object.entries(updates).forEach(([name, value]) => {
      element.style.setProperty(name, value);
    });
  });
}
```

## 主题层级覆盖

### 层级定义

```typescript
enum ThemeLevel {
  System = 0,      // 系统默认主题
  Global = 1,      // 全局主题
  App = 2,         // 应用主题
  Card = 3,        // 卡片主题
  Component = 4    // 组件主题
}

interface ThemeConfig {
  level: ThemeLevel;
  themeId: string;
  scope?: string;  // 作用域选择器
}
```

### 层级解析

```typescript
/**
 * 获取元素的有效主题
 * 从元素向上查找,找到最近的主题设置
 */
export function getEffectiveTheme(element: HTMLElement): string {
  let current: HTMLElement | null = element;
  
  while (current) {
    const theme = current.dataset.chipsTheme;
    if (theme) {
      return theme;
    }
    current = current.parentElement;
  }
  
  // 如果没有找到,返回全局默认主题
  return document.documentElement.dataset.chipsTheme || 'default';
}

/**
 * 应用主题到元素
 */
export function applyTheme(element: HTMLElement, themeId: string): void {
  element.dataset.chipsTheme = themeId;
}

/**
 * 移除元素的主题设置
 */
export function removeTheme(element: HTMLElement): void {
  delete element.dataset.chipsTheme;
}
```

### 主题继承链

```typescript
/**
 * 获取主题继承链
 * 从最高优先级到最低优先级
 */
export function getThemeChain(element: HTMLElement): string[] {
  const chain: string[] = [];
  let current: HTMLElement | null = element;
  
  while (current) {
    const theme = current.dataset.chipsTheme;
    if (theme) {
      chain.push(theme);
    }
    current = current.parentElement;
  }
  
  // 添加默认主题
  if (!chain.includes('default')) {
    chain.push('default');
  }
  
  return chain;
}

/**
 * 合并主题变量
 * 高优先级覆盖低优先级
 */
export function mergeThemeVariables(
  themeChain: string[],
  themeLoader: ThemeLoader
): Record<string, string> {
  const merged: Record<string, string> = {};
  
  // 从低优先级到高优先级遍历
  for (let i = themeChain.length - 1; i >= 0; i--) {
    const themeId = themeChain[i];
    const theme = themeLoader.getLoadedTheme(themeId);
    if (theme) {
      Object.assign(merged, theme.variables);
    }
  }
  
  return merged;
}
```

## 主题切换实现

### 无缝切换

```typescript
/**
 * 切换主题
 */
export async function switchTheme(
  element: HTMLElement,
  newThemeId: string,
  options: SwitchOptions = {}
): Promise<void> {
  const {
    animate = true,
    duration = 300,
    onStart,
    onComplete
  } = options;
  
  const oldThemeId = getEffectiveTheme(element);
  
  if (oldThemeId === newThemeId) {
    return; // 主题相同,无需切换
  }
  
  onStart?.();
  
  // 预加载新主题
  await themeLoader.load(newThemeId);
  
  if (animate) {
    // 添加过渡动画
    element.style.transition = `all ${duration}ms ease-in-out`;
    
    // 等待下一帧
    await new Promise(resolve => requestAnimationFrame(resolve));
  }
  
  // 应用新主题
  applyTheme(element, newThemeId);
  
  if (animate) {
    // 等待动画完成
    await new Promise(resolve => setTimeout(resolve, duration));
    
    // 移除过渡
    element.style.transition = '';
  }
  
  onComplete?.();
}
```

### 平滑过渡

```css
/* 主题切换过渡 */
.chips-theme-transition {
  transition: 
    background-color var(--chips-transition-base),
    color var(--chips-transition-base),
    border-color var(--chips-transition-base);
}

/* 特定属性的过渡 */
.chips-button {
  transition: 
    background-color var(--chips-transition-fast),
    border-color var(--chips-transition-fast),
    color var(--chips-transition-fast),
    box-shadow var(--chips-transition-fast);
}
```

### 主题预加载

```typescript
/**
 * 预加载主题
 */
export async function preloadTheme(themeId: string): Promise<void> {
  // 在空闲时预加载主题
  if ('requestIdleCallback' in window) {
    await new Promise<void>(resolve => {
      requestIdleCallback(async () => {
        await themeLoader.load(themeId);
        resolve();
      });
    });
  } else {
    await themeLoader.load(themeId);
  }
}

/**
 * 预加载常用主题
 */
export async function preloadCommonThemes(): Promise<void> {
  const commonThemes = ['default', 'dark', 'light'];
  await Promise.all(commonThemes.map(preloadTheme));
}
```

## 主题定制

### 运行时定制

```typescript
/**
 * 自定义主题变量
 */
export function customizeTheme(
  element: HTMLElement,
  customVariables: Record<string, string>
): void {
  Object.entries(customVariables).forEach(([name, value]) => {
    element.style.setProperty(name, value);
  });
}

/**
 * 创建主题变体
 */
export function createThemeVariant(
  baseThemeId: string,
  customVariables: Record<string, string>
): Theme {
  const baseTheme = themeLoader.getLoadedTheme(baseThemeId);
  if (!baseTheme) {
    throw new Error(`Base theme not found: ${baseThemeId}`);
  }
  
  return {
    id: `${baseThemeId}-custom`,
    name: `${baseTheme.name} (自定义)`,
    variables: {
      ...baseTheme.variables,
      ...customVariables
    }
  };
}
```

### 主题编辑器

```typescript
/**
 * 主题编辑器
 */
export class ThemeEditor {
  private element: HTMLElement;
  private originalVariables: Record<string, string>;
  private currentVariables: Record<string, string>;
  
  constructor(element: HTMLElement) {
    this.element = element;
    this.originalVariables = this.extractVariables();
    this.currentVariables = { ...this.originalVariables };
  }
  
  /**
   * 更新变量
   */
  updateVariable(name: string, value: string): void {
    this.currentVariables[name] = value;
    this.element.style.setProperty(name, value);
  }
  
  /**
   * 批量更新变量
   */
  updateVariables(variables: Record<string, string>): void {
    Object.assign(this.currentVariables, variables);
    injectCSSVariables(this.element, variables);
  }
  
  /**
   * 重置到原始值
   */
  reset(): void {
    this.currentVariables = { ...this.originalVariables };
    injectCSSVariables(this.element, this.originalVariables);
  }
  
  /**
   * 导出当前主题
   */
  export(): Theme {
    return {
      id: 'custom',
      name: '自定义主题',
      variables: { ...this.currentVariables }
    };
  }
  
  /**
   * 生成CSS代码
   */
  generateCSS(): string {
    const lines = Object.entries(this.currentVariables).map(
      ([name, value]) => `  ${name}: ${value};`
    );
    
    return `:root {\n${lines.join('\n')}\n}`;
  }
  
  private extractVariables(): Record<string, string> {
    const style = getComputedStyle(this.element);
    const variables: Record<string, string> = {};
    
    for (let i = 0; i < style.length; i++) {
      const prop = style[i];
      if (prop.startsWith('--chips-')) {
        variables[prop] = style.getPropertyValue(prop).trim();
      }
    }
    
    return variables;
  }
}
```

## 主题验证

### 完整性验证

```typescript
/**
 * 验证主题完整性
 */
export function validateTheme(theme: Theme): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];
  
  // 检查必需的变量
  const requiredVariables = [
    '--chips-color-primary',
    '--chips-color-success',
    '--chips-color-warning',
    '--chips-color-error',
    '--chips-font-size-base',
    '--chips-spacing-base',
    // ... 更多必需变量
  ];
  
  requiredVariables.forEach(varName => {
    if (!(varName in theme.variables)) {
      errors.push(`缺少必需变量: ${varName}`);
    }
  });
  
  // 检查变量值格式
  Object.entries(theme.variables).forEach(([name, value]) => {
    if (name.includes('color') && !isValidColor(value)) {
      errors.push(`无效的颜色值: ${name} = ${value}`);
    }
    
    if (name.includes('size') && !isValidSize(value)) {
      warnings.push(`可能无效的尺寸值: ${name} = ${value}`);
    }
  });
  
  return {
    valid: errors.length === 0,
    errors,
    warnings
  };
}

function isValidColor(value: string): boolean {
  // 检查是否是有效的颜色值
  const s = new Option().style;
  s.color = value;
  return s.color !== '';
}

function isValidSize(value: string): boolean {
  return /^\d+(\.\d+)?(px|em|rem|%)$/.test(value);
}
```

### 兼容性检查

```typescript
/**
 * 检查主题兼容性
 */
export function checkThemeCompatibility(
  theme: Theme,
  libraryVersion: string
): CompatibilityResult {
  const compatibility = theme.compatibility;
  
  if (!compatibility) {
    return { compatible: true, reason: '' };
  }
  
  const { minVersion, maxVersion } = compatibility;
  
  if (minVersion && compareVersions(libraryVersion, minVersion) < 0) {
    return {
      compatible: false,
      reason: `需要组件库版本 >= ${minVersion},当前版本 ${libraryVersion}`
    };
  }
  
  if (maxVersion && compareVersions(libraryVersion, maxVersion) > 0) {
    return {
      compatible: false,
      reason: `需要组件库版本 <= ${maxVersion},当前版本 ${libraryVersion}`
    };
  }
  
  return { compatible: true, reason: '' };
}
```

## 性能优化

### 主题缓存

```typescript
/**
 * 主题缓存管理器
 */
class ThemeCache {
  private cache = new Map<string, Theme>();
  private maxSize = 10;
  
  get(themeId: string): Theme | null {
    return this.cache.get(themeId) || null;
  }
  
  set(themeId: string, theme: Theme): void {
    // 如果缓存已满,移除最老的
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(themeId, theme);
  }
  
  clear(): void {
    this.cache.clear();
  }
}
```

### CSS优化

```css
/* 避免频繁计算的变量使用fixed值 */
.chips-button {
  /* ✅ 好: 直接使用变量 */
  padding: var(--chips-button-padding);
  
  /* ❌ 避免: 复杂计算 */
  padding: calc(var(--chips-spacing-base) * 2 + var(--chips-spacing-xs));
}

/* 使用will-change提示浏览器优化 */
.chips-theme-transition {
  will-change: background-color, color, border-color;
}

/* 动画完成后移除will-change */
.chips-theme-transition.complete {
  will-change: auto;
}
```

### 延迟加载

```typescript
/**
 * 延迟加载主题
 */
export function lazyLoadTheme(themeId: string): Promise<Theme> {
  return import(
    /* webpackChunkName: "theme-[request]" */
    `./themes/${themeId}`
  ).then(module => module.default);
}
```

## 总结

主题系统通过CSS变量、主题作用域、层级覆盖等机制,实现了功能与样式的完全分离。主题包作为独立产品,可以提供完整的视觉实现。系统支持原子级应用、动态切换、运行时定制,为用户提供了极大的视觉自由度。通过完善的加载、验证、缓存机制,确保了主题系统的稳定性和性能。
